# [Common Diffusion Noise Schedules and Sample Steps are Flawed](https://arxiv.org/abs/2305.08891)

## What is the central research question or hypothesis that this paper addresses?

Based on my reading of the paper, the central research question is: How can we ensure consistency between the training and inference behavior of diffusion models, so they can generate samples across the full range of brightness levels?The key hypotheses appear to be:1) Common diffusion noise schedules and sampling implementations have flaws that cause a discrepancy between training and inference. Specifically:- Noise schedules do not enforce zero signal-to-noise ratio (SNR) at the last timestep. This causes signal leakage during training.- Samplers do not always start from the last timestep. This exposes models to nonzero SNR inputs at inference. 2) Aligning the training and inference by enforcing zero terminal SNR, using v prediction, sampling from the last timestep, and rescaling classifier-free guidance will allow models to generate the full range of brightness.So in summary, the central research question is how to make diffusion training and inference congruent so models can generate samples with diverse brightness levels. The hypotheses are that common schedules and samplers have flaws, and fixing them will solve the problem.


## What is the main contribution of this paper?

The main contribution of this paper is identifying and fixing flaws in common diffusion noise schedules and sampling implementations that cause a discrepancy between training and inference. Specifically:- The paper points out that common noise schedules like linear, cosine, and the schedule used in Stable Diffusion do not enforce zero signal-to-noise ratio (SNR) at the last timestep. This causes some signal information to leak to the model during training, while at inference the model gets pure noise. - The paper proposes rescaling existing schedules to ensure zero terminal SNR, which aligns the training and inference distributions.- The paper highlights that many sampling implementations like DDIM and PNDM do not properly start from the last timestep, further contributing to the discrepancy. The paper advocates always sampling from the last step.- To counter image over-exposure from a zero SNR schedule, the paper proposes a simple rescaling method for classifier-free guidance.- The paper shows both qualitatively and quantitatively that these fixes allow models to generate samples with a full range of brightness as opposed to just medium brightness, and that the samples better match the true data distribution.In summary, the main contribution is identifying flaws in existing diffusion training and sampling methods, and proposing simple fixes to align the behavior between training and inference. This results in improved sample quality and diversity.


## What is the TL;DR (Too Long, Didn't Read) version of the paper? If you had to summarize it in one sentence, what would that be?

Here is a one sentence TL;DR summary of the paper:The paper discovers flaws in common diffusion model training procedures, namely noise schedules that leak signal and samplers that don't start from the last timestep, and proposes fixes like rescaling schedules to zero SNR, using v prediction, always sampling from the last step, and rescaling classifier guidance to enable models to generate the full range of brightness.


## How does this paper compare to other research in the same field?

Here are a few thoughts on how this CVPR 2022 paper compares to other research on diffusion models:- The key contribution is identifying issues with common diffusion noise schedules and sampler implementations that can cause inconsistencies between training and inference. Previous work like DDPM, DDIM, etc focused more on developing new diffusion schemes and sampling algorithms but didn't analyze these potential inconsistencies in-depth.- The proposed solutions like enforcing zero terminal SNR, using v prediction, proper sampling steps, and classifier-free guidance rescaling are simple but effective fixes to address the issues. Other recent work like Imagen and offset noise also tried to address some of the same problems but through more complex solutions.- The paper provides both qualitative results showing the model can now handle a full range of brightness levels, and quantitative FID/IS improvements. This demonstrates the practical benefits of their fixes over the flawed default implementations.- The work is mainly focused on fixing issues specifically observed in Stable Diffusion. But the authors argue the insights likely generalize to other diffusion models as well. So it contributes broadly to understanding proper training/inference alignment in diffusion models.- Compared to other generative model research, this work doesn't introduce major architectural changes or novel objectives. The contributions are more about careful analysis of existing methods and simple fixes. But this is still valuable for improving real-world diffusion models.Overall, I would say this is a focused analysis that clearly identifies issues with common practices in training diffusion models, and proposes simple solutions that are well motivated from first principles. The work is not as technically novel or complex as some other generative modeling papers, but provides practical insights that could improve many existing diffusion model implementations.


## What future research directions do the authors suggest?

Based on my reading of the paper, some key future research directions the authors suggest are:- Developing noise schedules that inherently enforce zero terminal SNR, rather than needing to be rescaled after definition. The authors suggest that future schedule designs should ensure βT=1 to achieve this.- Further exploration of v prediction and v loss for training models with zero terminal SNR schedules. The authors find v prediction works well in their experiments but suggest more work could be done to optimize loss weighting λt. - Improving classifier-free guidance techniques to work well with zero terminal SNR schedules, without causing over-exposure. The proposed guidance rescaling is one approach but the authors suggest more work can be done in this area.- Applying the fixes proposed in the paper, such as zero terminal SNR and proper sampling steps, to other diffusion model implementations beyond just Stable Diffusion. The flawed designs identified are general issues so the authors encourage fixing them across different models.- Developing unconditional image generation models that properly learn the mean brightness of the full dataset distribution when trained with zero terminal SNR schedules.- Further analysis and experimentation on the model behavior and image variation when sampling with zero terminal SNR schedules.In summary, key directions are improving schedule and sampling designs for zero terminal SNR, adapting classifier guidance, applying fixes to other models, building better unconditional models, and further analysis of zero SNR model behavior. The authors have shown the importance of proper training/inference alignment and suggest more work based on this foundation.


## Summarize the paper in one paragraph.

Here is a one paragraph summary of the paper:The paper discovers flaws in common diffusion noise schedules and sampling implementations that cause a discrepancy between training and inference. The noise schedules do not enforce zero signal-to-noise ratio (SNR) at the last timestep, allowing some signal to leak during training. The samplers also do not always start from the last timestep. This causes the model to learn to generate images with medium brightness, as the leaked signal and incorrect sampling contain biased information about the mean. The paper proposes solutions to enforce zero terminal SNR in noise schedules, use v prediction and loss for training, always sample from the last timestep, and rescale classifier-free guidance to prevent over-exposure. Experiments on Stable Diffusion show the flaws severely limit its brightness range, and the proposed fixes allow the model to generate the full range of brightness and better match the true data distribution. The flaws apply generally to diffusion models, and the solutions ensure training and inference are properly aligned.


## Summarize the paper in two paragraphs.

Here is a two paragraph summary of the paper:This paper discovers flaws in common diffusion noise schedules and sampling implementations that cause a discrepancy between training and inference. The flaws restrict models like Stable Diffusion to only generating images with medium brightness. The root issues are that common schedules like linear and cosine do not enforce zero signal-to-noise ratio (SNR) on the last timestep, and samplers like DDIM and PNDM do not start sampling from the last timestep. The authors propose simple fixes: 1) Rescale existing schedules to ensure zero terminal SNR. 2) Train with v prediction and v loss to handle zero SNR. 3) Always sample starting from the last timestep. 4) Rescale classifier-free guidance to prevent over-exposure. Experiments show these fixes allow models to generate the full range of brightness and better fit the true image distribution. The authors argue diffusion models should align training and inference by enforcing zero terminal SNR and proper sampling order. The flaws are general and should be addressed in future diffusion model designs.


## Summarize the main method used in the paper in one paragraph.

The paper proposes a few simple fixes to address issues with common diffusion noise schedules and sampling implementations that cause a discrepancy between training and inference. The key points are:- Common diffusion noise schedules like linear and cosine do not enforce zero signal-to-noise ratio (SNR) on the last timestep. This causes the model to learn to respect residual signal in the input at the last timestep during training, which is inconsistent with pure noise input at inference. - The paper proposes rescaling existing schedules to enforce zero terminal SNR, by setting the sqrt(alpha_bar) of the last timestep to 0 and linearly interpolating the values in between.- With zero terminal SNR, epsilon prediction becomes useless so the paper suggests training with v prediction and v loss instead. - Many sampling implementations like DDIM and PNDM do not include the last timestep in the sampling process. The paper argues sampling should always start from the last timestep to be consistent with zero SNR training.- As terminal SNR approaches zero, classifier-free guidance can cause overexposed images. The paper proposes a simple rescaling method on the guidance output to prevent overexposure.- Experiments show these fixes allow models to generate a full range of brightness and better match the true data distribution. The core idea is to align diffusion training and inference by enforcing zero terminal SNR and proper sampling.
